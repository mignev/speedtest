function url_sep(t){return t.match(/\?/)?"&":"?"}function clearRequests(){if(xhr){for(var t=0;t<xhr.length;t++){if(useFetchAPI)try{xhr[t].cancelRequested=!0}catch(e){}try{xhr[t].onprogress=null,xhr[t].onload=null,xhr[t].onerror=null}catch(e){}try{xhr[t].upload.onprogress=null,xhr[t].upload.onload=null,xhr[t].upload.onerror=null}catch(e){}try{xhr[t].abort()}catch(e){}try{delete xhr[t]}catch(e){}}xhr=null}}function getIp(t){return"-1"==settings.url_getIp?void t():(xhr=new XMLHttpRequest,xhr.onload=function(){clientIp=xhr.responseText,t()},xhr.onerror=function(){t()},xhr.open("GET",settings.url_getIp+url_sep(settings.url_getIp)+"r="+Math.random(),!0),void xhr.send())}function dlTest(t){if(!dlCalled){if(dlCalled=!0,"-1"==settings.url_dl)return void t();var e=0,r=(new Date).getTime(),n=!1,i=!1;xhr=[];for(var s=function(t,r){setTimeout(function(){if(1===testStatus){var r=0,n=new XMLHttpRequest;xhr[t]=n,xhr[t].onprogress=function(t){if(1!==testStatus)try{n.abort()}catch(i){}var s=t.loaded<=0?0:t.loaded-r;isNaN(s)||!isFinite(s)||0>s||(e+=s,r=t.loaded)}.bind(this),xhr[t].onload=function(){try{xhr[t].abort()}catch(e){}s(t,0)}.bind(this),xhr[t].onerror=function(){0===settings.xhr_ignoreErrors&&(i=!0);try{xhr[t].abort()}catch(e){}delete xhr[t],1===settings.xhr_ignoreErrors&&s(t,100)}.bind(this);try{settings.xhr_dlUseBlob?xhr[t].responseType="blob":xhr[t].responseType="arraybuffer"}catch(a){}xhr[t].open("GET",settings.url_dl+url_sep(settings.url_dl)+"r="+Math.random()+"&ckSize="+settings.garbagePhp_chunkSize,!0),xhr[t].send()}}.bind(this),1+r)}.bind(this),a=0;a<settings.xhr_dlMultistream;a++)s(a,100*a);interval=setInterval(function(){var s=(new Date).getTime()-r;if(!(200>s))if(n){var a=e/(s/1e3);dlStatus=(8*a*settings.overheadCompensationFactor/1048576).toFixed(2),(s/1e3>settings.time_dl&&dlStatus>0||i)&&((i||isNaN(dlStatus))&&(dlStatus="Fail"),clearRequests(),clearInterval(interval),t())}else s>1e3*settings.time_dlGraceTime&&(e>0&&(r=(new Date).getTime(),e=0),n=!0)}.bind(this),200)}}function ulTest(t){if(!ulCalled){if(ulCalled=!0,"-1"==settings.url_ul)return void t();var e=0,r=(new Date).getTime(),n=!1,i=!1;xhr=[];for(var s=function(t,r){setTimeout(function(){if(3===testStatus){var r=0,n=new XMLHttpRequest;xhr[t]=n;var a;try{xhr[t].upload.onprogress,a=!1}catch(l){a=!0}a?(xhr[t].onload=function(){e+=262144,s(t,0)},xhr[t].onerror=function(){0===settings.xhr_ignoreErrors&&(i=!0);try{xhr[t].abort()}catch(e){}delete xhr[t],1===settings.xhr_ignoreErrors&&s(t,100)},xhr[t].open("POST",settings.url_ul+url_sep(settings.url_ul)+"r="+Math.random(),!0),xhr[t].setRequestHeader("Content-Encoding","identity"),xhr[t].send(reqsmall)):(xhr[t].upload.onprogress=function(t){if(3!==testStatus)try{n.abort()}catch(i){}var s=t.loaded<=0?0:t.loaded-r;isNaN(s)||!isFinite(s)||0>s||(e+=s,r=t.loaded)}.bind(this),xhr[t].upload.onload=function(){s(t,0)}.bind(this),xhr[t].upload.onerror=function(){0===settings.xhr_ignoreErrors&&(i=!0);try{xhr[t].abort()}catch(e){}delete xhr[t],1===settings.xhr_ignoreErrors&&s(t,100)}.bind(this),xhr[t].open("POST",settings.url_ul+url_sep(settings.url_ul)+"r="+Math.random(),!0),xhr[t].setRequestHeader("Content-Encoding","identity"),xhr[t].send(req))}}.bind(this),1)}.bind(this),a=0;a<settings.xhr_ulMultistream;a++)s(a,100*a);interval=setInterval(function(){var s=(new Date).getTime()-r;if(!(200>s))if(n){var a=e/(s/1e3);ulStatus=(8*a*settings.overheadCompensationFactor/1048576).toFixed(2),(s/1e3>settings.time_ul&&ulStatus>0||i)&&((i||isNaN(ulStatus))&&(ulStatus="Fail"),clearRequests(),clearInterval(interval),t())}else s>1e3*settings.time_ulGraceTime&&(e>0&&(r=(new Date).getTime(),e=0),n=!0)}.bind(this),200)}}function pingTest(t){if(!ptCalled){if(ptCalled=!0,"-1"==settings.url_ping)return void t();var e=null,r=0,n=0,i=0,s=0;xhr=[];var a=function(){e=(new Date).getTime(),xhr[0]=new XMLHttpRequest,xhr[0].onload=function(){if(0===i)e=(new Date).getTime();else{var l=(new Date).getTime()-e,u=Math.abs(l-s);1===i?r=l:(r=.9*r+.1*l,n=u>n?.2*n+.8*u:.9*n+.1*u),s=l}pingStatus=r.toFixed(2),jitterStatus=n.toFixed(2),i++,i<settings.count_ping?a():t()}.bind(this),xhr[0].onerror=function(){0===settings.xhr_ignoreErrors&&(pingStatus="Fail",jitterStatus="Fail",clearRequests(),t()),1===settings.xhr_ignoreErrors&&a(),2===settings.xhr_ignoreErrors&&(i++,i<settings.count_ping?a():t())}.bind(this),xhr[0].open("GET",settings.url_ping+url_sep(settings.url_ping)+"r="+Math.random(),!0),xhr[0].send()}.bind(this);a()}}var testStatus=0,dlStatus="",ulStatus="",pingStatus="",jitterStatus="",clientIp="",settings={time_ul:15,time_dl:15,time_ulGraceTime:3,time_dlGraceTime:1.5,count_ping:35,url_dl:"garbage.php",url_ul:"empty.php",url_ping:"empty.php",url_getIp:"https://api.ipify.org/",xhr_dlMultistream:10,xhr_ulMultistream:3,xhr_ignoreErrors:1,xhr_dlUseBlob:!1,garbagePhp_chunkSize:20,enable_quirks:!0,overheadCompensationFactor:1048576/925e3},xhr=null,interval=null,useFetchAPI=!1;this.addEventListener("message",function(t){var e=t.data.split(" ");if("status"===e[0]&&postMessage(testStatus+";"+dlStatus+";"+ulStatus+";"+pingStatus+";"+clientIp+";"+jitterStatus),"start"===e[0]&&0===testStatus){testStatus=1;try{var r={};try{var n=t.data.substring(5);n&&(r=JSON.parse(n))}catch(t){console.warn("Error parsing custom settings JSON. Please check your syntax")}if("undefined"!=typeof r.url_dl&&(settings.url_dl=r.url_dl),"undefined"!=typeof r.url_ul&&(settings.url_ul=r.url_ul),"undefined"!=typeof r.url_ping&&(settings.url_ping=r.url_ping),"undefined"!=typeof r.url_getIp&&(settings.url_getIp=r.url_getIp),"undefined"!=typeof r.time_dl&&(settings.time_dl=r.time_dl),"undefined"!=typeof r.time_ul&&(settings.time_ul=r.time_ul),"undefined"!=typeof r.enable_quirks&&(settings.enable_quirks=r.enable_quirks),settings.enable_quirks){var i=navigator.userAgent;/Firefox.(\d+\.\d+)/i.test(i)&&(settings.xhr_ulMultistream=1),/Edge.(\d+\.\d+)/i.test(i)&&(settings.xhr_dlMultistream=3),/Chrome.(\d+)/i.test(i)&&self.fetch&&(settings.xhr_dlMultistream=5)}"undefined"!=typeof r.count_ping&&(settings.count_ping=r.count_ping),"undefined"!=typeof r.xhr_dlMultistream&&(settings.xhr_dlMultistream=r.xhr_dlMultistream),"undefined"!=typeof r.xhr_ulMultistream&&(settings.xhr_ulMultistream=r.xhr_ulMultistream),"undefined"!=typeof r.xhr_ignoreErrors&&(settings.xhr_ignoreErrors=r.xhr_ignoreErrors),"undefined"!=typeof r.xhr_dlUseBlob&&(settings.xhr_dlUseBlob=r.xhr_dlUseBlob),"undefined"!=typeof r.garbagePhp_chunkSize&&(settings.garbagePhp_chunkSize=r.garbagePhp_chunkSize),"undefined"!=typeof r.time_dlGraceTime&&(settings.time_dlGraceTime=r.time_dlGraceTime),"undefined"!=typeof r.time_ulGraceTime&&(settings.time_ulGraceTime=r.time_ulGraceTime),"undefined"!=typeof r.overheadCompensationFactor&&(settings.overheadCompensationFactor=r.overheadCompensationFactor)}catch(t){console.warn("Possible error in custom test settings. Some settings may not be applied. Exception: "+t)}console.log(settings),getIp(function(){dlTest(function(){testStatus=2,pingTest(function(){testStatus=3,ulTest(function(){testStatus=4})})})})}"abort"===e[0]&&(clearRequests(),interval&&clearInterval(interval),testStatus=5,dlStatus="",ulStatus="",pingStatus="",jitterStatus="")});var dlCalled=!1,r=new ArrayBuffer(1048576);try{r=new Float32Array(r);for(var i=0;i<r.length;i++)r[i]=Math.random()}catch(e){}for(var req=[],reqsmall=[],i=0;20>i;i++)req.push(r);req=new Blob(req),r=new ArrayBuffer(262144);try{r=new Float32Array(r);for(var i=0;i<r.length;i++)r[i]=Math.random()}catch(e){}reqsmall.push(r),reqsmall=new Blob(reqsmall);var ulCalled=!1,ptCalled=!1;
